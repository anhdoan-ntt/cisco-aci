# test with FortiManager Galaxy 1.0.2
- name: Discover and Add Fortigate device
  hosts: fortimanager01
  gather_facts: no
  connection: httpapi
  collections:
    - fortinet.fortimanager
  vars:
    ansible_httpapi_use_ssl: True
    ansible_httpapi_validate_certs: False
    ansible_httpapi_port: 443
    device_ip: 192.168.190.130
    device_user: admin
    device_password: ca$hc0w
  tasks:
    - name: discover device
      fmgr_dvm_cmd_discover_device:
         method: exec
         params:
            - data:
                device:
                   adm_pass: "{{ device_password }}"
                   adm_usr: "{{ device_user }}"
                   ip: "{{ device_ip }}"
      register: probed_device


    - name: add device
      fmgr_dvm_cmd_add_device:
        loose_validation: true
        method: exec
        params:
            - data:
                adom: root
                device:
                    # adm_pass is defined as a string in schema.
                    # here we turn on loose_validation to skip validation.
                    adm_pass: "{{ probed_device.meta.data.device.adm_pass }}"
                    adm_usr: "{{ probed_device.meta.data.device.adm_usr }}"
                    desc: "The device is added via Ansible"
                    ip: "{{ probed_device.meta.data.device.ip }}"
                    mgmt_mode: "fmg"
                    name: "{{ probed_device.meta.data.device.name }}"
                    sn: "{{ probed_device.meta.data.device.sn }}"
                flags:
                    - create_task
                    - nonblocking
      register: installing_task

    - name: query long-term task status
      fmgr_task_task_obj:
        method: get
        url_params:
            task: "{{ installing_task.meta.data.taskid }}"
      register: taskinfo
      until: taskinfo.meta.data.percent == 100
      # poll for 30 * 10 = 300 seconds.
      retries: 30
      delay: 10

    - name: detect errors in previous task
      fail:
        msg: 'the device is not installed correctly'
      failed_when: taskinfo.meta.data.state == 'error' and 'devsnexist' not in taskinfo.meta.data.line[0].detail
