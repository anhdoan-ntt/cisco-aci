# test with FortiManager Galaxy 1.0.2
- name: Delete Fortigate device
  hosts: fortimanager01
  gather_facts: no
  connection: httpapi
  collections:
    - fortinet.fortimanager
  vars:
    ansible_httpapi_use_ssl: True
    ansible_httpapi_validate_certs: False
    ansible_httpapi_port: 443
    device_name: CustomHostname 
    device_adom: root

  tasks:
    - name: create the task to delete the device
      fmgr_dvm_cmd_del_device:
        method: 'exec'
        params:
          - data:
              adom: '{{ device_adom }}'
              device: '{{ device_name }}'
              flags:
                - create_task
                - nonblocking
      register: uninstalling_task
   
    - name: query the task
      when: uninstalling_task.meta.status.code == 0
      fmgr_task_task_obj:
        method: 'get'
        url_params:
            task: "{{ uninstalling_task.meta.data.taskid }}"
      register: taskinfo
      until: taskinfo.meta.data.percent == 100
      retries: 30
      delay: 10


    - name: Detect errors in previous task
      when: uninstalling_task.meta.status.code == 0
      fail:
        msg: 'the device is not installed correctly, see more in log'
      failed_when: taskinfo.meta.data.num_err != 0 or taskinfo.meta.data.state == 'error'
